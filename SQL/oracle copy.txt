Sub DisplayTotals()
    Dim ws As Worksheet
    Dim conn As Object
    Dim rs As Object
    Dim sql As String
    Dim i As Integer
    
    ' 対象のワークシートを指定（必要に応じて変更）
    Set ws = ThisWorkbook.Sheets("Sheet1")
    
    ' SQLクエリを構築
    sql = "SELECT element, SUM(value) AS total FROM your_table GROUP BY element ORDER BY element;"
    
    ' ADOオブジェクトを作成
    Set conn = CreateObject("ADODB.Connection")
    Set rs = CreateObject("ADODB.Recordset")
    
    ' データベースに接続（接続文字列は適切に設定）
    conn.Open "Provider=YourProvider;Data Source=YourDataSource;User ID=YourUserID;Password=YourPassword;"
    
    ' クエリを実行
    rs.Open sql, conn
    
    ' 結果をエクセルに出力
    ws.Range("A1").Value = "要素"
    ws.Range("B1").Value = "合計"
    
    i = 2
    Do Until rs.EOF
        ws.Cells(i, 1).Value = rs.Fields("element").Value
        ws.Cells(i, 2).Value = rs.Fields("total").Value
        i = i + 1
        rs.MoveNext
    Loop
    
    ' クリーンアップ
    rs.Close
    Set rs = Nothing
    conn.Close
    Set conn = Nothing
End Sub

ユーザーが期間を指定してデータを取得するには、SQLの CASE 文を使用して期間内のデータを抽出し、COUNT 関数でカウントを計算します。また、LEFT JOIN を使用して、期間内にデータが存在しない場合も考慮します。以下は、この要件に基づいたSQLクエリの例です。

sql
Copy code
SELECT
    t.TYPE,
    p.PROCESS,
    k.KIND,
    COUNT(CASE WHEN d.DATE BETWEEN '2024/1/26' AND '2024/1/30' THEN 1 ELSE NULL END) AS COUNT
FROM
    (SELECT DISTINCT TYPE FROM your_table) t
CROSS JOIN
    (SELECT DISTINCT PROCESS FROM your_table) p
CROSS JOIN
    (SELECT DISTINCT KIND FROM your_table) k
LEFT JOIN
    your_table d
ON
    t.TYPE = d.TYPE
    AND p.PROCESS = d.PROCESS
    AND k.KIND = d.KIND
GROUP BY
    t.TYPE,
    p.PROCESS,
    k.KIND
ORDER BY
    t.TYPE,
    p.PROCESS,
    k.KIND;
上記のクエリでは、CROSS JOIN を使用してTYPE、PROCESS、KINDの組み合わせを生成し、LEFT JOIN を使用して実際のデータと組み合わせています。期間内のデータは COUNT 関数と CASE 文でカウントしています。期間内にデータが存在しない場合は、COUNT は0になります。

このクエリを実行する際は、your_table を実際のデータベーステーブルの名前に置き換え、期間を適切に指定してください。


